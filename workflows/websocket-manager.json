{
  "name": "WebSocket Manager & Real-time Communication",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "websocket-event",
        "options": {}
      },
      "id": "websocket-webhook",
      "name": "WebSocket Event Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "jsCode": "// Process and route WebSocket events\nconst eventData = $input.first().json;\n\n// Validate event structure\nif (!eventData.event_type || !eventData.payload) {\n  throw new Error('Invalid WebSocket event structure');\n}\n\nconst processedEvent = {\n  event_id: eventData.event_id || Date.now().toString(),\n  event_type: eventData.event_type,\n  timestamp: new Date().toISOString(),\n  payload: eventData.payload,\n  client_id: eventData.client_id || 'unknown',\n  requires_broadcast: true\n};\n\n// Determine routing based on event type\nswitch (eventData.event_type) {\n  case 'new_message':\n    processedEvent.target_clients = 'all';\n    processedEvent.priority = 'high';\n    break;\n    \n  case 'suggestions_ready':\n    processedEvent.target_clients = [eventData.client_id];\n    processedEvent.priority = 'high';\n    break;\n    \n  case 'system_status':\n    processedEvent.target_clients = 'all';\n    processedEvent.priority = 'normal';\n    break;\n    \n  case 'user_typing':\n    processedEvent.target_clients = 'others';\n    processedEvent.priority = 'low';\n    processedEvent.ttl = 3000; // 3 second TTL\n    break;\n    \n  default:\n    processedEvent.target_clients = 'all';\n    processedEvent.priority = 'normal';\n}\n\nconsole.log(`Processing WebSocket event: ${processedEvent.event_type}`);\n\nreturn {\n  json: processedEvent\n};"
      },
      "id": "process-event",
      "name": "Process WebSocket Event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {\n          \"options\": {\n            \"caseSensitive\": true,\n            \"leftValue\": \"\",\n            \"typeValidation\": \"strict\"\n          },\n          \"conditions\": [\n            {\n              \"id\": \"condition1\",\n              \"leftValue\": \"={{ $json.priority }}\",\n              \"rightValue\": \"high\",\n              \"operator\": {\n                \"type\": \"string\",\n                \"operation\": \"equals\"\n              }\n            }\n          ],\n          \"combinator\": \"and\"\n        },\n        \"options\": {}\n      },\n      \"id\": \"priority-check\",\n      \"name\": \"High Priority?\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"typeVersion\": 2,\n      \"position\": [680, 300]\n    },\n    {\n      \"parameters\": {\n        \"url\": \"http://backend:3001/api/websocket/broadcast\",\n        \"sendHeaders\": true,\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Content-Type\",\n              \"value\": \"application/json\"\n            },\n            {\n              \"name\": \"X-Priority\",\n              \"value\": \"high\"\n            }\n          ]\n        },\n        \"sendBody\": true,\n        \"jsonBody\": \"={{ JSON.stringify($json) }}\",\n        \"options\": {\n          \"timeout\": 2000\n        }\n      },\n      \"id\": \"high-priority-broadcast\",\n      \"name\": \"High Priority Broadcast\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [900, 200]\n    },\n    {\n      \"parameters\": {\n        \"url\": \"http://backend:3001/api/websocket/broadcast\",\n        \"sendHeaders\": true,\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Content-Type\",\n              \"value\": \"application/json\"\n            }\n          ]\n        },\n        \"sendBody\": true,\n        \"jsonBody\": \"={{ JSON.stringify($json) }}\",\n        \"options\": {\n          \"timeout\": 5000\n        }\n      },\n      \"id\": \"normal-broadcast\",\n      \"name\": \"Normal Priority Broadcast\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [900, 400]\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// Log broadcast results and update connection metrics\\nconst broadcastResult = $input.first().json;\\nconst originalEvent = $json;\\n\\n// Create activity log entry\\nconst logEntry = {\\n  timestamp: new Date().toISOString(),\\n  event_id: originalEvent.event_id,\\n  event_type: originalEvent.event_type,\\n  priority: originalEvent.priority,\\n  broadcast_status: broadcastResult.success ? 'success' : 'failed',\\n  clients_reached: broadcastResult.clients_reached || 0,\\n  response_time_ms: broadcastResult.response_time || 0,\\n  error: broadcastResult.error || null\\n};\\n\\n// Update connection health metrics\\nconst metrics = {\\n  total_events_processed: 1,\\n  high_priority_events: originalEvent.priority === 'high' ? 1 : 0,\\n  successful_broadcasts: logEntry.broadcast_status === 'success' ? 1 : 0,\\n  average_response_time: logEntry.response_time_ms,\\n  timestamp: logEntry.timestamp\\n};\\n\\nconsole.log(`WebSocket event processed: ${originalEvent.event_type} - ${logEntry.broadcast_status}`);\\n\\nreturn {\\n  json: {\\n    log_entry: logEntry,\\n    metrics: metrics,\\n    original_event: originalEvent\\n  }\\n};\"\n      },\n      \"id\": \"log-activity\",\n      \"name\": \"Log Broadcast Activity\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [1120, 300]\n    },\n    {\n      \"parameters\": {\n        \"url\": \"http://backend:3001/api/webhooks/websocket-metrics\",\n        \"sendHeaders\": true,\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Content-Type\",\n              \"value\": \"application/json\"\n            }\n          ]\n        },\n        \"sendBody\": true,\n        \"jsonBody\": \"={{ JSON.stringify($json.metrics) }}\",\n        \"options\": {}\n      },\n      \"id\": \"update-metrics\",\n      \"name\": \"Update Connection Metrics\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [1340, 300]\n    }\n  ],\n  \"connections\": {\n    \"WebSocket Event Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Process WebSocket Event\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Process WebSocket Event\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"High Priority?\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"High Priority?\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"High Priority Broadcast\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Normal Priority Broadcast\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"High Priority Broadcast\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Log Broadcast Activity\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Normal Priority Broadcast\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Log Broadcast Activity\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Log Broadcast Activity\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Update Connection Metrics\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"active\": true,\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"versionId\": \"1\",\n  \"meta\": {\n    \"templateCreatedBy\": \"n8n@1.0.0\",\n    \"instanceId\": \"whatsapp-reply-assistant\"\n  },\n  \"id\": \"4\",\n  \"tags\": [\"websocket\", \"realtime\", \"communication\"]\n}"